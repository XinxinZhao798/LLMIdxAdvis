SELECT cc.cc_name AS call_center_name, cc.cc_city AS call_center_city, cc.cc_state AS call_center_state, hd.hd_income_band_sk AS income_band, COUNT(DISTINCT sr.sr_ticket_number) AS total_returns, SUM(sr.sr_return_quantity) AS total_returned_items, AVG(sr.sr_return_amt) AS average_return_amount, SUM(sr.sr_return_amt_inc_tax) AS total_return_amount_including_tax, SUM(sr.sr_net_loss) AS total_net_loss FROM call_center cc JOIN store_returns sr ON cc.cc_call_center_sk = sr.sr_store_sk JOIN household_demographics hd ON sr.sr_hdemo_sk = hd.hd_demo_sk JOIN warehouse w ON cc.cc_state = w.w_state WHERE w.w_county = 'Williamson County' AND hd.hd_demo_sk = 1887 AND cc.cc_rec_start_date <= CURRENT_DATE AND (cc.cc_rec_end_date IS NULL OR cc.cc_rec_end_date > CURRENT_DATE) GROUP BY call_center_name, call_center_city, call_center_state, income_band ORDER BY total_returns DESC, total_returned_items DESC;
SELECT cc.cc_name, cc.cc_city, cc.cc_state, SUM(cr.cr_return_amount) AS total_return_amount, AVG(cr.cr_return_amount) AS avg_return_amount, COUNT(cr.cr_order_number) AS total_returns, SUM(cr.cr_return_quantity) AS total_returned_items, COUNT(DISTINCT cr.cr_returning_customer_sk) AS unique_returning_customers, SUM(case when hd.hd_dep_count IS NOT NULL THEN 1 ELSE 0 END) AS returns_with_dep_count, SUM(case when hd.hd_vehicle_count IS NOT NULL THEN 1 ELSE 0 END) AS returns_with_vehicle_count, COUNT(DISTINCT p.p_promo_sk) AS total_promotions_involved, SUM(p.p_cost) AS total_promotion_cost FROM call_center cc LEFT JOIN catalog_returns cr ON cc.cc_call_center_sk = cr.cr_call_center_sk LEFT JOIN household_demographics hd ON cr.cr_returning_hdemo_sk = hd.hd_demo_sk LEFT JOIN promotion p ON p.p_item_sk = cr.cr_item_sk WHERE cc.cc_company_name IN ('able', 'ought', 'cally', 'pri') AND cc.cc_hours IN ('8AM-4PM', '8AM-8AM') AND p.p_channel_tv = 'N' AND p.p_purpose = 'Unknown' AND cr.cr_refunded_cash IN ('5415.08', '1.89', '288.51', '2.49', '307.01') GROUP BY cc.cc_name, cc.cc_city, cc.cc_state ORDER BY total_return_amount DESC;
SELECT w_state, cd_education_status, SUM(cr_return_amount) AS total_return_amount, AVG(cr_return_quantity) AS avg_return_quantity, COUNT(DISTINCT cr_order_number) AS total_orders_returned, SUM(inv_quantity_on_hand) AS total_inventory_on_hand FROM catalog_returns JOIN customer_demographics ON cr_returning_cdemo_sk = cd_demo_sk JOIN warehouse ON cr_warehouse_sk = w_warehouse_sk JOIN inventory ON (catalog_returns.cr_warehouse_sk = inventory.inv_warehouse_sk AND catalog_returns.cr_item_sk = inventory.inv_item_sk) JOIN web_page ON cr_catalog_page_sk = wp_web_page_sk WHERE w_street_type IN ('Drive', 'Dr.', 'Avenue', 'Parkway') AND cd_dep_count IN (1, 2) AND cd_education_status IN ('Secondary', 'Unknown') AND wp_max_ad_count = 2 AND wp_autogen_flag = 'Y' GROUP BY w_state, cd_education_status ORDER BY total_return_amount DESC, avg_return_quantity DESC, total_orders_returned DESC, total_inventory_on_hand DESC;
SELECT cc.cc_name, cc.cc_class, COUNT(DISTINCT c.c_customer_sk) AS total_customers, AVG(cd.cd_purchase_estimate) AS avg_purchase_estimate, SUM(cd.cd_dep_count) AS total_dependents, COUNT(DISTINCT inv.inv_warehouse_sk) AS unique_warehouses, SUM(inv.inv_quantity_on_hand) AS total_inventory FROM call_center cc JOIN customer c ON (cc.cc_call_center_sk = c.c_current_addr_sk) JOIN customer_demographics cd ON (c.c_current_cdemo_sk = cd.cd_demo_sk) JOIN inventory inv ON (cc.cc_sq_ft = inv.inv_quantity_on_hand) WHERE cc.cc_sq_ft IN (649, 2268, 795, 3514, 1138) AND c.c_birth_month IN (3, 5) AND c.c_birth_day = 18 GROUP BY cc.cc_name, cc.cc_class ORDER BY total_customers DESC, avg_purchase_estimate DESC;
SELECT d_year, d_quarter_name, s_state, COUNT(DISTINCT s_store_sk) AS number_of_stores, SUM(s_number_employees) AS total_employees, AVG(s_floor_space) AS avg_floor_space, SUM(wp_char_count) AS total_char_count, AVG(wp_link_count) AS avg_link_count, AVG(wp_image_count) AS avg_image_count, COUNT(DISTINCT wp_web_page_sk) AS number_of_web_pages, SUM(CASE WHEN wp_max_ad_count = 3 THEN 1 ELSE 0 END) AS count_max_ad_3, AVG(s_tax_precentage) AS avg_tax_percentage FROM store JOIN date_dim ON s_rec_end_date = d_date LEFT JOIN web_page ON wp_access_date_sk = d_date_sk WHERE s_rec_end_date BETWEEN '1999-01-01' AND '2001-12-31' AND wp_url LIKE 'http://www.foo.com%' AND wp_max_ad_count IN ('1', '2', '3', '4') GROUP BY d_year, d_quarter_name, s_state ORDER BY d_year DESC, d_quarter_name, s_state;
SELECT w_state, ca_state, s_state, web_state, COUNT(DISTINCT c.c_customer_sk) AS num_customers, COUNT(DISTINCT w.w_warehouse_sk) AS num_warehouses, COUNT(DISTINCT s.s_store_sk) AS num_stores, COUNT(DISTINCT web.web_site_sk) AS num_websites, SUM(ss_quantity) AS total_quantity_sold, SUM(ss_net_paid) AS total_net_paid, AVG(ss_net_profit) AS avg_net_profit, SUM(ss_net_paid_inc_tax) AS total_net_paid_inc_tax FROM store_sales ss JOIN store s ON ss.ss_store_sk = s.s_store_sk JOIN web_site web ON s.s_market_id = web.web_mkt_id JOIN warehouse w ON w.w_state = s.s_state JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk WHERE s.s_manager IN ('David Thomas', 'Scott Smith', 'William Ward', 'Brett Yates', 'Robert Thompson', 'Edwin Adams') AND web.web_city IN ('Fairview', 'Midway') AND s.s_market_id IN ('8', '6', '4', '2') GROUP BY ROLLUP(w_state, ca_state, s_state, web_state) ORDER BY w_state, ca_state, s_state, web_state;
SELECT c.c_customer_id, c.c_first_name, c.c_last_name, SUM(ss.ss_net_paid) AS total_sales, AVG(ss.ss_net_profit) AS avg_profit, COUNT(DISTINCT ss.ss_ticket_number) AS num_of_sales, SUM(sr.sr_net_loss) AS total_returns_loss, COUNT(DISTINCT sr.sr_ticket_number) AS num_of_returns, SUM(CASE WHEN sr.sr_refunded_cash > 0 THEN 1 ELSE 0 END) AS num_of_cash_refunds FROM customer c LEFT JOIN store_sales ss ON c.c_customer_sk = ss.ss_customer_sk LEFT JOIN store_returns sr ON c.c_customer_sk = sr.sr_customer_sk GROUP BY c.c_customer_id, c.c_first_name, c.c_last_name HAVING SUM(ss.ss_net_paid) > 0 OR SUM(sr.sr_net_loss) > 0 ORDER BY total_sales DESC, total_returns_loss DESC;
SELECT reason.r_reason_desc AS Return_Reason, COUNT(DISTINCT web_returns.wr_order_number) AS Total_Returns, SUM(web_returns.wr_return_amt) AS Total_Return_Amount, AVG(web_returns.wr_return_amt) AS Average_Return_Amount, promotion.p_promo_name AS Promotion_Name, COUNT(DISTINCT promotion.p_promo_sk) AS Total_Promotions_Affected, ship_mode.sm_type AS Shipping_Type, COUNT(DISTINCT ship_mode.sm_ship_mode_sk) AS Total_Shipping_Modes_Used FROM web_returns JOIN reason ON web_returns.wr_reason_sk = reason.r_reason_sk LEFT JOIN promotion ON web_returns.wr_item_sk = promotion.p_item_sk JOIN web_page ON web_returns.wr_web_page_sk = web_page.wp_web_page_sk JOIN ship_mode ON web_returns.wr_order_number = ship_mode.sm_ship_mode_sk WHERE web_returns.wr_return_amt > 0 AND reason.r_reason_desc IN ('No service location in my area', 'Did not like the warranty', 'Stopped working') AND web_page.wp_link_count BETWEEN 15 AND 24 GROUP BY Return_Reason, Promotion_Name, Shipping_Type ORDER BY Total_Returns DESC, Total_Return_Amount DESC;
SELECT d_year, i_category, SUM(inv_quantity_on_hand) AS total_inventory, AVG(i_current_price) AS avg_item_price, COUNT(DISTINCT inv_warehouse_sk) AS num_warehouses, SUM(wr_return_amt) AS total_return_amount, AVG(wr_return_ship_cost) AS avg_return_ship_cost, COUNT(DISTINCT wr_order_number) AS num_returns FROM inventory JOIN item ON inv_item_sk = i_item_sk JOIN date_dim ON inv_date_sk = d_date_sk LEFT JOIN web_returns ON wr_item_sk = i_item_sk AND wr_returned_date_sk = d_date_sk WHERE d_year = 2002 GROUP BY d_year, i_category ORDER BY total_inventory DESC, total_return_amount DESC LIMIT 10;
SELECT d_year, d_quarter_name, cd_gender, cd_education_status, SUM(ws_net_profit) AS total_net_profit, AVG(ws_quantity) AS avg_quantity_sold, COUNT(DISTINCT ws_order_number) AS total_orders, SUM(sr_return_amt) AS total_return_amount, AVG(sr_return_quantity) AS avg_return_quantity, COUNT(DISTINCT sr_ticket_number) AS total_return_transactions FROM web_sales JOIN date_dim ON ws_sold_date_sk = d_date_sk JOIN customer_demographics ON ws_bill_cdemo_sk = cd_demo_sk LEFT JOIN store_returns ON sr_customer_sk = ws_bill_customer_sk AND sr_returned_date_sk = ws_sold_date_sk WHERE d_year = 1999 AND cd_dep_employed_count = 0 AND ws_ext_tax IN ('56.09', '24.79', '237.72', '4.60', '438.93', '37.94') AND ws_web_site_sk IN ('15', '25', '16', '12', '19') AND sr_customer_sk IN ('34000', '49632', '58331', '36235') GROUP BY d_year, d_quarter_name, cd_gender, cd_education_status ORDER BY total_net_profit DESC, total_orders DESC;
SELECT c.c_customer_id AS customer_id, CONCAT(c.c_last_name, ', ', c.c_first_name) AS customer_name, cd.cd_gender, cd.cd_marital_status, cd.cd_education_status, cd.cd_purchase_estimate, hd.hd_income_band_sk, hd.hd_buy_potential, COUNT(cr.cr_order_number) AS total_returns, SUM(cr.cr_return_quantity) AS total_returned_quantity, AVG(cr.cr_return_amount) AS avg_return_amount, SUM(cr.cr_return_amt_inc_tax) AS total_return_amount_inc_tax, SUM(cr.cr_net_loss) AS total_net_loss FROM customer c JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk JOIN household_demographics hd ON c.c_current_hdemo_sk = hd.hd_demo_sk JOIN catalog_returns cr ON c.c_customer_sk = cr.cr_returning_customer_sk WHERE c.c_first_sales_date_sk IN (2452027, 2451966, 2450163) AND cr.cr_returned_time_sk IN (66035, 17738, 73881) AND cr.cr_return_quantity = 49 GROUP BY customer_id, customer_name, cd.cd_gender, cd.cd_marital_status, cd.cd_education_status, cd.cd_purchase_estimate, hd.hd_income_band_sk, hd.hd_buy_potential ORDER BY total_returns DESC, total_returned_quantity DESC LIMIT 100;
SELECT hd.hd_dep_count, hd.hd_vehicle_count, ib.ib_lower_bound, ib.ib_upper_bound, COUNT(DISTINCT p.p_promo_sk) AS num_promotions, SUM(p.p_cost) AS total_promo_cost, AVG(p.p_cost) AS avg_promo_cost, COUNT(DISTINCT r.r_reason_sk) AS num_reasons, AVG(hd.hd_vehicle_count) AS avg_vehicle_count, SUM(CASE WHEN p.p_channel_event = 'N' THEN 1 ELSE 0 END) AS non_event_promos, SUM(CASE WHEN p.p_response_target = 1 THEN 1 ELSE 0 END) AS target_response_promos FROM promotion p JOIN household_demographics hd ON p.p_item_sk = hd.hd_demo_sk JOIN income_band ib ON hd.hd_income_band_sk = ib.ib_income_band_sk LEFT JOIN reason r ON r.r_reason_sk = p.p_promo_sk WHERE p.p_channel_event = 'N' AND p.p_response_target = 1 GROUP BY hd.hd_dep_count, hd.hd_vehicle_count, ib.ib_lower_bound, ib.ib_upper_bound ORDER BY total_promo_cost DESC, num_promotions DESC;
SELECT d_year, d_quarter_name, COUNT(DISTINCT cc_call_center_sk) AS num_call_centers, COUNT(DISTINCT w_warehouse_sk) AS num_warehouses, COUNT(DISTINCT sr_item_sk) AS num_returned_items, COUNT(DISTINCT wp_web_page_sk) AS num_web_pages, COUNT(DISTINCT web_site_sk) AS num_web_sites, SUM(sr_return_amt) AS total_return_amount, AVG(w_warehouse_sq_ft) AS avg_warehouse_size, SUM(wp_image_count) AS total_images_on_web_pages FROM date_dim LEFT JOIN call_center ON (cc_open_date_sk = d_date_sk OR cc_closed_date_sk = d_date_sk) LEFT JOIN warehouse ON d_date_sk = w_warehouse_sk LEFT JOIN store_returns ON sr_returned_date_sk = d_date_sk LEFT JOIN web_page ON wp_creation_date_sk = d_date_sk OR wp_access_date_sk = d_date_sk LEFT JOIN web_site ON web_open_date_sk = d_date_sk OR web_close_date_sk = d_date_sk WHERE d_year = 2001 AND (web_site.web_street_type = 'Court' OR web_site.web_street_type = 'Way') AND warehouse.w_county = 'Williamson County' AND warehouse.w_street_name LIKE '6th%' AND web_page.wp_max_ad_count BETWEEN 0 AND 4 AND web_page.wp_rec_start_date BETWEEN '1999-09-01' AND '2001-09-05' AND date_dim.d_fy_week_seq IN (84, 305, 207, 95) GROUP BY d_year, d_quarter_name ORDER BY d_year, d_quarter_name;
SELECT c.c_birth_country, COUNT(DISTINCT c.c_customer_sk) AS num_customers, SUM(ss.ss_quantity) AS total_quantity_sold, AVG(ss.ss_net_paid_inc_tax) AS avg_net_paid_inc_tax, SUM(CASE WHEN ss.ss_net_paid_inc_tax > 1000 THEN ss.ss_quantity ELSE 0 END) AS quantity_sold_above_1000, COUNT(DISTINCT p.p_promo_sk) AS num_promotions, SUM(p.p_cost) AS total_promotion_cost, w.w_state, COUNT(DISTINCT w.w_warehouse_sk) AS num_warehouses, SUM(w.w_warehouse_sq_ft) AS total_warehouse_sq_ft FROM customer c JOIN store_sales ss ON c.c_customer_sk = ss.ss_customer_sk JOIN promotion p ON ss.ss_promo_sk = p.p_promo_sk JOIN warehouse w ON w.w_zip = c.c_current_addr_sk::character varying WHERE c.c_birth_country IN ('THAILAND', 'ITALY') AND ss.ss_net_paid_inc_tax::text IN ('307.45', '859.21', '1169.72', '3293.51', '222.26') GROUP BY c.c_birth_country, w.w_state ORDER BY total_quantity_sold DESC;
SELECT d.d_year, i.i_category, SUM(sr.sr_return_amt) AS total_return_amount, AVG(sr.sr_return_quantity) AS avg_return_quantity, COUNT(DISTINCT sr.sr_customer_sk) AS unique_customers, w.w_state, w.w_city FROM store_returns sr JOIN date_dim d ON sr.sr_returned_date_sk = d.d_date_sk JOIN item i ON sr.sr_item_sk = i.i_item_sk JOIN warehouse w ON sr.sr_addr_sk = w.w_warehouse_sk WHERE d.d_year = 2023 AND i.i_category_id BETWEEN 1 AND 100 AND w.w_suite_number IN ('Suite 80', 'Suite 0', 'Suite P', 'Suite 470') GROUP BY d.d_year, i.i_category, w.w_state, w.w_city ORDER BY total_return_amount DESC, avg_return_quantity DESC;
SELECT d_year, d_quarter_name, s_state, COUNT(distinct ss_ticket_number) as total_sales_transactions, SUM(ss_quantity) as total_quantity_sold, SUM(ss_ext_sales_price) as total_sales_value, AVG(ss_sales_price) as average_sales_price, SUM(ss_ext_discount_amt) as total_discount_amount, AVG(ss_ext_discount_amt/ss_quantity) as average_discount_per_unit, SUM(ss_net_paid) as total_net_paid, SUM(ss_net_profit) as total_net_profit FROM store_sales JOIN date_dim ON store_sales.ss_sold_date_sk = date_dim.d_date_sk JOIN store ON store_sales.ss_store_sk = store.s_store_sk GROUP BY d_year, d_quarter_name, s_state ORDER BY d_year, d_quarter_name, s_state;
SELECT d_year, i_category, i_class, SUM(ws_sales_price) AS total_sales, AVG(ws_sales_price) AS avg_sales_price, COUNT(DISTINCT ws_order_number) AS num_orders, SUM(sr_return_amt) AS total_returns, AVG(sr_return_amt) AS avg_return_amt, COUNT(DISTINCT sr_ticket_number) AS num_returns, SUM(ws_net_profit) - SUM(sr_net_loss) AS net_profit FROM web_sales JOIN item ON ws_item_sk = i_item_sk JOIN date_dim ON ws_sold_date_sk = d_date_sk LEFT JOIN store_returns ON sr_item_sk = ws_item_sk AND sr_returned_date_sk = ws_sold_date_sk WHERE d_year = 2002 AND (i_category = 'Electronics' OR i_category = 'Books') AND ws_sales_price > 0 GROUP BY d_year, i_category, i_class ORDER BY d_year, i_category, i_class;
SELECT c.c_customer_id, c.c_first_name, c.c_last_name, SUM(ws.ws_net_paid_inc_ship_tax) AS total_sales, SUM(ws.ws_ext_ship_cost) AS total_shipping_costs, COUNT(DISTINCT ws.ws_order_number) AS number_of_orders, AVG(ws.ws_net_paid_inc_ship_tax) AS avg_order_value, SUM(cr.cr_return_amount) AS total_returns, AVG(cr.cr_return_amount) AS avg_return_value, COUNT(DISTINCT cr.cr_order_number) AS number_of_returns, SUM(cr.cr_store_credit) AS total_store_credit_issued, SUM(wr.wr_net_loss) AS total_web_net_loss FROM customer c LEFT JOIN web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk LEFT JOIN catalog_returns cr ON c.c_customer_sk = cr.cr_returning_customer_sk LEFT JOIN web_returns wr ON c.c_customer_sk = wr.wr_returning_customer_sk WHERE ws.ws_ext_ship_cost IN ('445.80', '1378.08') OR ws.ws_net_paid_inc_ship_tax IN ('3521.86', '4835.64', '451.77', '1948.62') OR cr.cr_return_tax IN ('8.78', '157.04', '14.40', '364.85', '21.09', '27.15') OR cr.cr_store_credit IN ('1.34', '1072.41', '2042.86', '1698.25', '143.92') GROUP BY c.c_customer_id, c.c_first_name, c.c_last_name ORDER BY total_sales DESC, number_of_orders DESC, total_returns DESC;
SELECT sm.sm_type, sm.sm_carrier, COUNT(DISTINCT inv.inv_item_sk) AS distinct_items_shipped, SUM(inv.inv_quantity_on_hand) AS total_quantity_on_hand, AVG(inv.inv_quantity_on_hand) AS avg_quantity_per_item, s.s_store_name, s.s_company_name, s.s_city, s.s_state, COUNT(DISTINCT s.s_store_sk) AS number_of_stores, AVG(s.s_number_employees) AS avg_employees_per_store, SUM(s.s_floor_space) AS total_floor_space FROM ship_mode sm JOIN inventory inv ON sm.sm_ship_mode_sk = inv.inv_warehouse_sk JOIN store s ON inv.inv_warehouse_sk = s.s_store_sk WHERE inv.inv_item_sk = 11749 AND s.s_rec_end_date IS NULL GROUP BY sm.sm_type, sm.sm_carrier, s.s_store_name, s.s_company_name, s.s_city, s.s_state ORDER BY total_quantity_on_hand DESC, avg_employees_per_store DESC LIMIT 100;
SELECT s.s_division_name, AVG(s.s_floor_space) AS avg_floor_space, AVG(s.s_number_employees) AS avg_number_employees, AVG(ib.ib_upper_bound) AS avg_income_upper_bound, COUNT(wp.wp_web_page_sk) AS web_page_count, SUM(wp.wp_image_count) AS total_image_count, SUM(wp.wp_link_count) AS total_link_count FROM store AS s INNER JOIN income_band AS ib ON s.s_store_sk = ib.ib_income_band_sk LEFT JOIN web_page AS wp ON wp.wp_customer_sk = s.s_store_sk WHERE s.s_rec_start_date >= '2020-01-01' AND (s.s_rec_end_date IS NULL OR s.s_rec_end_date <= '2023-01-01') AND ib.ib_upper_bound BETWEEN 60000 AND 190000 AND wp.wp_type = 'monthly' GROUP BY s.s_division_name ORDER BY avg_floor_space DESC, avg_number_employees DESC;
SELECT cs.cs_order_number AS order_number, SUM(cs.cs_quantity) AS total_quantity, AVG(cs.cs_sales_price) AS average_sales_price, SUM(cs.cs_net_paid) AS total_net_paid, SUM(cs.cs_net_profit) AS total_net_profit, COUNT(DISTINCT cs.cs_bill_customer_sk) AS unique_customers, ib.ib_lower_bound AS income_lower_bound, ib.ib_upper_bound AS income_upper_bound, SUM(ws.ws_quantity) AS web_total_quantity, AVG(ws.ws_sales_price) AS web_average_sales_price, SUM(ws.ws_net_paid) AS web_total_net_paid, SUM(ws.ws_net_profit) AS web_total_net_profit, COUNT(DISTINCT ws.ws_bill_customer_sk) AS web_unique_customers FROM catalog_sales cs JOIN income_band ib ON cs.cs_bill_hdemo_sk = ib.ib_income_band_sk JOIN web_sales ws ON cs.cs_item_sk = ws.ws_item_sk AND cs.cs_order_number = ws.ws_order_number WHERE cs.cs_ext_tax IN (0.56, 96.57, 30.68, 46.59, 64.13) AND ib.ib_income_band_sk IN (19, 17, 16, 10, 1) GROUP BY cs.cs_order_number, ib.ib_lower_bound, ib.ib_upper_bound ORDER BY total_net_profit DESC, web_total_net_profit DESC LIMIT 100;
SELECT SUM(ss.ss_net_profit) AS total_net_profit, AVG(ss.ss_quantity) AS average_quantity_sold, COUNT(DISTINCT ss.ss_customer_sk) AS unique_customers, COUNT(DISTINCT sr.sr_reason_sk) AS number_of_return_reasons, SUM(sr.sr_return_amt_inc_tax) AS total_returns_with_tax, AVG(p.p_cost) AS average_promotion_cost, COUNT(DISTINCT w.w_warehouse_sk) AS number_of_warehouses_used, AVG(w.w_gmt_offset) AS average_warehouse_gmt_offset, SUM(CASE WHEN c.c_preferred_cust_flag = 'Y' THEN 1 ELSE 0 END) AS preferred_customer_count FROM store_sales ss LEFT JOIN store_returns sr ON ss.ss_ticket_number = sr.sr_ticket_number LEFT JOIN promotion p ON ss.ss_promo_sk = p.p_promo_sk AND p.p_discount_active = 'N' LEFT JOIN warehouse w ON w.w_suite_number IN ('Suite 80', 'Suite 0', 'Suite P', 'Suite 470') LEFT JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk WHERE (ss.ss_sold_date_sk BETWEEN 20180101 AND 20181231 OR ss.ss_sold_date_sk IS NULL) AND (sr.sr_returned_date_sk BETWEEN 20180101 AND 20181231 OR sr.sr_returned_date_sk IS NULL) AND (c.c_customer_sk IN ('824', '4397', '807', '476') OR c.c_customer_sk IS NULL) AND (sr.sr_reason_sk IN (SELECT r_reason_sk FROM reason WHERE r_reason_desc IN ('duplicate purchase', 'reason 34', 'Found a better price in a store', 'Gift exchange', 'Parts missing', 'Lost my job')) OR sr.sr_reason_sk IS NULL) GROUP BY w.w_city, c.c_birth_year;
SELECT wsit.web_site_id, wsit.web_name, COUNT(DISTINCT ws.ws_order_number) AS total_orders, SUM(ws.ws_net_paid) AS total_sales, AVG(ws.ws_sales_price) AS avg_sales_price, COUNT(DISTINCT wr.wr_order_number) AS total_returns, AVG(wr.wr_return_amt) AS avg_return_amt, SUM(CASE WHEN ws.ws_promo_sk IS NOT NULL THEN 1 ELSE 0 END) AS promo_sales_count, SUM(CASE WHEN ws.ws_promo_sk IS NULL THEN 1 ELSE 0 END) AS non_promo_sales_count, AVG(hd.hd_dep_count) AS avg_household_dependents, AVG(hd.hd_vehicle_count) AS avg_household_vehicles FROM web_sales ws LEFT JOIN web_site wsit ON ws.ws_web_site_sk = wsit.web_site_sk LEFT JOIN web_returns wr ON ws.ws_order_number = wr.wr_order_number AND ws.ws_item_sk = wr.wr_item_sk LEFT JOIN customer c ON ws.ws_bill_customer_sk = c.c_customer_sk LEFT JOIN household_demographics hd ON c.c_current_hdemo_sk = hd.hd_demo_sk LEFT JOIN promotion p ON ws.ws_promo_sk = p.p_promo_sk GROUP BY wsit.web_site_id, wsit.web_name ORDER BY total_sales DESC;
